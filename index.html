<!DOCTYPE html>
<html lang=en>
<head>
  <meta charset="utf-8">
  <title></title>
<style>
body {
  background-color: #ccc;
  margin: 0;
}
img {
  /*margin: 1em;*/
}
canvas {
  margin:0.1em;
}
</style>  
</head>
<body>
<script>
;(function (){
  var rowCount = 5
  var colCount = 5
  var edgeList = []
  var topsList = [] // Ensures that pieces interlock with the row above
 
  var width
  var height
  var neck

  var imageObj = new Image()
  imageObj.onload = function() {
    var imgWidth = imageObj.width
    var imgHeight = imageObj.height
    width = imgWidth / colCount
    height = imgHeight / rowCount
    neck = width / 6

    createPuzzlePieces()
  };

  imageObj.src = "squares.png" // "raven.png"

  function createPuzzlePieces(me) {   
    var piecesList = []
    var edge
      
    for(var row = 0; row < rowCount; row += 1) {
      for(var col = 0; col < colCount; col += 1) {
        createPuzzlePiece(row, col)
      }
    }

    function createPuzzlePiece(row, col) {
      var canvas = document.createElement('canvas')
      var context = canvas.getContext('2d');
      canvas.width = width + neck * 2.5
      canvas.height = height + neck * 2.5
      //document.body.appendChild(canvas)

      context.beginPath()
      context.moveTo(neck, height + neck)
      
      // LEFT
      if (!col) {
        // The left edge is flat
        context.lineTo(neck, neck)
      } else {
        // Use previous right edge
        upwardEdge(neck, height + neck, edge)
      }

      // TOP
      if (!row) {
        context.lineTo(width + neck, neck)
      } else {
       // Use previous bottom edge
        rightwardEdge(width + neck, neck, topsList[col])
      }

      // RIGHT
      if ((col + 1) === colCount) {
        context.lineTo(width + neck, height + neck)
      } else {
        // Create a new right edge
        edge = randomEdge()
        downwardEdge(width + neck, height + neck, edge)
      }

      // BOTTOM    
      if (row + 1 === rowCount) {
        context.lineTo(neck, height + neck)
      } else {
        // Create a new bottom edge       
        topsList[col] = randomEdge()
        leftwardEdge(width + neck, height + neck, topsList[col])
      }
      context.clip()

      createImg()

      function downwardEdge(x0, height, edge) {
        // {
        //   tilt: tilt
        // , slant: slant
        // , angle: angle
        // , curve: curve
        // }
        var x1 = x0 - edge.curve     // shoulder
        var x2 = x0 + edge.curve / 5 // chin
        var x3 = x0 + neck * 1.2     // crown

        var y0 = neck
        var ym = y0 + (height - y0) / 2 // adjusted with tilt
        var y1 = ym - neck / 2      // top of neck
        var y2 = ym + neck / 2      // bottom of neck
        var y3 = ym - neck * 2      // top of slant
        var y4 = ym + neck * 2      // foot of slant

        context.bezierCurveTo(
          x0, y0                   // no handle on corner
        , x1, y1 - edge.angle     // base of neck
        , x0, y1                  // upper neck point
        )
        context.bezierCurveTo(
          x2, y1 + edge.angle / 5 // chin side of neck
        , x3 - edge.slant, y3     // upper slant
        , x3, ym + edge.tilt      // top of head
        )
        context.bezierCurveTo(
          x3 + edge.slant, y4     // lower slant
        , x2, y2 + edge.angle / 5 // chin side of neck
        , x0, y2                  // lower neck point
        )
        context.bezierCurveTo(
          x1, y2 - edge.angle     // base of neck
        , x0, height              // no handle on corner
        , x0, height              // corner
        )
      }

      function upwardEdge(x0, height, edge) {
        var x1 = x0 - edge.curve     // shoulder
        var x2 = x0 + edge.curve / 5 // chin
        var x3 = x0 + neck * 1.2     // crown

        var y0 = neck
        var ym = y0 + (height - y0) / 2 // adjusted with tilt
        var y1 = ym - neck / 2   // top of neck
        var y2 = ym + neck / 2   // bottom of neck
        var y3 = ym - neck * 2      // top of slant
        var y4 = ym + neck * 2     // foot of slant

        //context.lineTo(x0, neck)

        context.bezierCurveTo(
          x0, height              // no handle on corner
        , x1, y2 - edge.angle     // base of neck
        , x0, y2                  // upper neck point
        )
        context.bezierCurveTo(
          x2, y2 + edge.angle / 5 // chin side of neck
        , x3 + edge.slant, y4     // lower slant
        , x3, ym + edge.tilt      // top of head
        )
        context.bezierCurveTo(
          x3 - edge.slant, y3     // upper slant
        , x2, y1 + edge.angle / 5 // chin side of neck
        , x0, y1                  // lower neck point
        )
        context.bezierCurveTo(
          x1, y1 - edge.angle     // base of neck
        , x0, y0                   // no handle on corner
        , x0, y0                   // corner
        )
      }
   
      function leftwardEdge(width, y0, edge) {
        var y1 = y0 - edge.curve     // shoulder
        var y2 = y0 + edge.curve / 5 // chin
        var y3 = y0 + neck * 1.2     // crown

        var x0 = neck
        var xm = x0 + (width - x0) / 2 // adjusted with tilt
        var x1 = xm - neck / 2   // top of neck
        var x2 = xm + neck / 2   // bottom of neck
        var x3 = xm - neck * 2      // top of slant
        var x4 = xm + neck * 2     // foot of slant

        context.bezierCurveTo(
          width, y0              // no handle on corner
        , x2 - edge.angle, y1     // base of neck
        , x2, y0                  // upper neck point
        )
        context.bezierCurveTo(
          x2 + edge.angle / 5, y2 // chin side of neck
        , x4, y3 + edge.slant     // lower slant
        , xm + edge.tilt, y3      // top of head
        )
        context.bezierCurveTo(
          x3, y3 - edge.slant     // upper slant
        , x1 + edge.angle / 5, y2 // chin side of neck
        , x1, y0                  // lower neck point
        )
        context.bezierCurveTo(
          x1 - edge.angle, y1     // base of neck
        , x0, y0                   // no handle on corner
        , x0, y0                  // corner
        )
      }

      function rightwardEdge(width, y0, edge) {
        var y1 = y0 - edge.curve     // shoulder
        var y2 = y0 + edge.curve / 5 // chin
        var y3 = y0 + neck * 1.2     // crown

        var x0 = neck
        var xm = x0 + (width - x0) / 2 // adjusted with tilt
        var x1 = xm - neck / 2      // top of neck
        var x2 = xm + neck / 2      // bottom of neck
        var x3 = xm - neck * 2      // top of slant
        var x4 = xm + neck * 2      // foot of slant

        context.bezierCurveTo(
          x0, y0                  // no handle on corner
        , x1 - edge.angle, y1     // base of neck
        , x1, y0                  // upper neck point
        )
        context.bezierCurveTo(
          x1 + edge.angle / 5, y2 // chin side of neck
        , x3, y3 - edge.slant     // lower slant
        , xm + edge.tilt, y3      // top of head
        )
        context.bezierCurveTo(
          x4, y3 + edge.slant     // upper slant
        , x2 + edge.angle / 5, y2 // chin side of neck
        , x2, y0                  // lower neck point
        )
        context.bezierCurveTo(
          x2 - edge.angle, y1     // base of neck
        , width, y0                  // no handle on corner
        , width, y0               // corner
        )
      }
   
      function createImg() {
        var frame = document.createElement('canvas')
        var cadre = frame.getContext('2d');
        var clippedImage = new Image()
        var n = neck // * 1.5
        var n3 = neck * 2
        piecesList.push(clippedImage)

        context.drawImage(imageObj, -col*width + n, -row*height + n)

        clippedImage.onload = function(){
          // append the new image to the page
          document.body.appendChild(clippedImage)
          context = null
          canvas = null       
        }

        clippedImage.src = canvas.toDataURL()
      }
    }

    return piecesList
  }



  function randomEdge(topsList, column) {   
    var tilt
      , slant
      , angle
      , curve
      , edge

    do {
      tilt  =  6 - Math.floor(Math.random() * 11)
      slant =  6 - Math.floor(Math.random() * 11)
      angle =  6 - Math.floor(Math.random() * 11)
      curve = 14 + Math.floor(Math.random() * 11)
    } while (edgeExists())

    function edgeExists() {
      var unique = edgeList.every(function (edge) {
        if (edge.tilt !== tilt) {
          return true
        } else if (edge.slant !== slant) {
          return true
        } else if (edge.angle !== angle) {
          return true
        } else if (edge.curve !== curve) {
          return true
        }
        return false
      })

      return !unique
    }

    edge  = {
      tilt: tilt
    , slant: slant
    , angle: angle
    , curve: curve
    }

    edgeList.push(edge)

    if (topsList) {
      topsList[column] = edge
    }

    return edge
  }
  
})()
</script>

</body>
</html>